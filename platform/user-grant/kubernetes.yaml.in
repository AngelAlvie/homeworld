---
apiVersion: v1
kind: Service
metadata:
  name: user-grant
  namespace: kube-system
  labels:
    app: user-grant
spec:
  selector:
    app: user-grant
  ports:
  - name: https
    port: 443
    protocol: TCP
  type: NodePort
---
kind: ConfigMap
apiVersion: v1
metadata:
  name: user-grant-cfg
  namespace: kube-system
data:
  mit-ca.pem: |
    -----BEGIN CERTIFICATE-----
    MIIDODCCAqGgAwIBAgIBATANBgkqhkiG9w0BAQUFADBsMQswCQYDVQQGEwJVUzEW
    MBQGA1UECBMNTWFzc2FjaHVzZXR0czEuMCwGA1UEChMlTWFzc2FjaHVzZXR0cyBJ
    bnN0aXR1dGUgb2YgVGVjaG5vbG9neTEVMBMGA1UECxMMQ2xpZW50IENBIHYxMB4X
    DTA2MDYwNzIyMDcyNVoXDTI2MDgwMTIyMDcyNVowbDELMAkGA1UEBhMCVVMxFjAU
    BgNVBAgTDU1hc3NhY2h1c2V0dHMxLjAsBgNVBAoTJU1hc3NhY2h1c2V0dHMgSW5z
    dGl0dXRlIG9mIFRlY2hub2xvZ3kxFTATBgNVBAsTDENsaWVudCBDQSB2MTCBnzAN
    BgkqhkiG9w0BAQEFAAOBjQAwgYkCgYEAwV11Ca4OyWTnlF6FH8z8MwCUa3L5JxuF
    srLsz7arGeTDS39WjWywDgCZM3vOCvOpziGFYzicS7n4JQuy04QuT+6Xdc2bEx7u
    JOhoeTz/VypA4DIwcsv20I63Cgr14aMNz5Ur4KWQjyn6zcgQ276fnM/cJD3wzAzX
    2fU9mF/1LFECAwEAAaOB6TCB5jAdBgNVHQ4EFgQUARibj0xtym66P6slAv0eCMB6
    wo8wgZYGA1UdIwSBjjCBi4AUARibj0xtym66P6slAv0eCMB6wo+hcKRuMGwxCzAJ
    BgNVBAYTAlVTMRYwFAYDVQQIEw1NYXNzYWNodXNldHRzMS4wLAYDVQQKEyVNYXNz
    YWNodXNldHRzIEluc3RpdHV0ZSBvZiBUZWNobm9sb2d5MRUwEwYDVQQLEwxDbGll
    bnQgQ0EgdjGCAQEwDAYDVR0TBAUwAwEB/zALBgNVHQ8EBAMCAQYwEQYJYIZIAYb4
    QgEBBAQDAgEGMA0GCSqGSIb3DQEBBQUAA4GBAC/J7KTQjDXUi9xANDWxZmKc02Yn
    90TBhqbg/f7em6/9SHO9vcSGr04atve79wCxgM46m1Hvd493sxyTgPJSH5Un6GrK
    8CQ1Iyqq4gXvjLBORblricOCnyu5KaaZ63NjYxnjwvwN2uy9opsuXmijMAJ/gL7r
    4Gd9vK+Uzsz0qmJP
    -----END CERTIFICATE-----
---
apiVersion: v1
kind: Secret
metadata:
  name: user-grant-secrets
  namespace: kube-system
type: Opaque
data:
  server.key: {{{{SERVER_KEY_BASE64}}}}
  server.pem: {{{{SERVER_CERT_BASE64}}}}
  issuer.key: {{{{ISSUER_KEY_BASE64}}}}
  issuer.pem: {{{{ISSUER_CERT_BASE64}}}}
---
apiVersion: v1
kind: ReplicationController
metadata:
  name: user-grant
  namespace: kube-system
  labels:
    app: user-grant
spec:
  replicas: 1
  selector:
    app: user-grant
  template:
    metadata:
      labels:
        app: user-grant
    spec:
      containers:
      - name: user-grant
        image: homeworld.private/user-grant:{version}
        command:
        - /usr/bin/user-grant
        - upstream-ca=/config/mit-ca.pem
        - kube-ca=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        - server-key=/secret/server.key
        - server-cert=/secret/server.pem
        - issuer-key=/secret/issuer.key
        - issuer-cert=/secret/issuer.pem
        - "apiserver={{{{SOME_APISERVER}}}}"
        - email-domain=MIT.EDU  # TODO: parameterize
        ports:
        - containerPort: 443
          name: https
          protocol: TCP
        volumeMounts:
        - name: user-grant-cfg
          mountPath: /config/
        - name: user-grant-secrets
          mountPath: /secret/
      volumes:
      - name: user-grant-cfg
        configMap:
          name: user-grant-cfg
      - name: user-grant-secrets
        secret:
          secretName: user-grant-secrets
