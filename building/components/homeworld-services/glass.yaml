control:
  name: homeworld-services
  version: 0.1.35
  date: 2018-07-30T21:58:00-0700
  type: deb
  depends:
    - homeworld-rkt
    - homeworld-etcd
    - homeworld-hyperkube (>= 1.8.0)
    - openssl
    - curl
    - ca-certificates
    - homeworld-etcd-metrics-exporter
    - homeworld-aci-pull-monitor
    - iptables
    - conntrack

build:
  - type: bash
    code: |
      mkdir -p ${OUTPUT}/usr/lib/systemd/system/
      find /h/src/ -name '*.service' -exec cp {} ${OUTPUT}/usr/lib/systemd/system/ ';'
      find /h/src/ -name '*.timer' -exec cp {} ${OUTPUT}/usr/lib/systemd/system/ ';'

  - type: bash
    code: |
      mkdir -p ${OUTPUT}/usr/lib/hyades/
      find /h/src/ -name 'launch-*.sh' -exec cp {} ${OUTPUT}/usr/lib/hyades/ ';'

  - type: copy
    input: 10-containernet.conf
    output: /etc/rkt/net.d/10-containernet.conf

  - type: python
    code: |
      import os
      fingerprint = context.branch_config.signing_key.lower()
      dest = context.output('/etc/rkt/trustedkeys/prefix.d/homeworld.private/' + fingerprint)
      signing_key = aptbranch.export_key(context.branch_config.signing_key, armor=True)
      os.makedirs(os.path.dirname(dest))
      with open(dest, 'wb') as f:
          f.write(signing_key)
